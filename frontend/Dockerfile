# =============================================
# DeepAudit Frontend Docker æ„å»º
# =============================================
# ä½¿ç”¨ Nginx æä¾›é™æ€æ–‡ä»¶å’Œåå‘ä»£ç† (æ”¯æŒ SSE æµå¼ä¼ è¾“)

FROM node:20-slim AS builder

WORKDIR /app

# å½»åº•æ¸…é™¤ä»£ç†è®¾ç½®
ENV http_proxy=""
ENV https_proxy=""
ENV HTTP_PROXY=""
ENV HTTPS_PROXY=""
ENV all_proxy=""
ENV ALL_PROXY=""
ENV no_proxy="*"
ENV NO_PROXY="*"

# é…ç½®å›½å†… npm é•œåƒæº
RUN npm config set registry https://registry.npmmirror.com && \
    npm install -g pnpm && \
    pnpm config set registry https://registry.npmmirror.com

# å¤åˆ¶ä¾èµ–æ–‡ä»¶
COPY package.json pnpm-lock.yaml ./

# å¢åŠ ç½‘ç»œè¶…æ—¶è®¾ç½®å’Œå¹¶å‘æ•°é™åˆ¶ï¼Œé˜²æ­¢ ARM æ¶æ„æ„å»ºå¡æ­»
RUN pnpm config set network-timeout 300000 && \
    pnpm config set fetch-retries 5 && \
    pnpm install --no-frozen-lockfile --network-concurrency 1

# å¤åˆ¶æºä»£ç 
COPY . .

# ğŸ”¥ æ„å»ºæ—¶ä½¿ç”¨ç›¸å¯¹è·¯å¾„ /api - Nginx ä¼šå¤„ç†ä»£ç†
ENV VITE_API_BASE_URL=/api/v1

# æ„å»ºç”Ÿäº§ç‰ˆæœ¬
RUN pnpm build

# =============================================
# ç”Ÿäº§é•œåƒ - ä½¿ç”¨ Nginx (æ”¯æŒ SSE åå‘ä»£ç†)
# =============================================
FROM nginx:alpine

# å¤åˆ¶æ„å»ºäº§ç‰©
COPY --from=builder /app/dist /usr/share/nginx/html

# å¤åˆ¶ Nginx é…ç½® (åŒ…å« SSE åå‘ä»£ç†é…ç½®)
COPY nginx.conf /etc/nginx/conf.d/default.conf

EXPOSE 80

CMD ["nginx", "-g", "daemon off;"]
