# =============================================
# DeepAudit Frontend Docker æ„å»º
# =============================================
# ä½¿ç”¨ Nginx æä¾›é™æ€æ–‡ä»¶å’Œåå‘ä»£ç† (æ”¯æŒ SSE æµå¼ä¼ è¾“)

FROM node:20-alpine AS builder

WORKDIR /app

# æ¸…é™¤ä»£ç†è®¾ç½®
ENV http_proxy=
ENV https_proxy=
ENV HTTP_PROXY=
ENV HTTPS_PROXY=

RUN unset http_proxy https_proxy HTTP_PROXY HTTPS_PROXY all_proxy ALL_PROXY && \
    npm install -g pnpm

# å¤åˆ¶ä¾èµ–æ–‡ä»¶
COPY package.json pnpm-lock.yaml ./

RUN unset http_proxy https_proxy HTTP_PROXY HTTPS_PROXY all_proxy ALL_PROXY && \
    pnpm install --no-frozen-lockfile

# å¤åˆ¶æºä»£ç 
COPY . .

# ğŸ”¥ æ„å»ºæ—¶ä½¿ç”¨ç›¸å¯¹è·¯å¾„ /api - Nginx ä¼šå¤„ç†ä»£ç†
ENV VITE_API_BASE_URL=/api/v1

# æ„å»ºç”Ÿäº§ç‰ˆæœ¬
RUN pnpm build

# =============================================
# ç”Ÿäº§é•œåƒ - ä½¿ç”¨ Nginx (æ”¯æŒ SSE åå‘ä»£ç†)
# =============================================
FROM nginx:alpine

# å¤åˆ¶æ„å»ºäº§ç‰©
COPY --from=builder /app/dist /usr/share/nginx/html

# å¤åˆ¶ Nginx é…ç½® (åŒ…å« SSE åå‘ä»£ç†é…ç½®)
COPY nginx.conf /etc/nginx/conf.d/default.conf

EXPOSE 80

CMD ["nginx", "-g", "daemon off;"]
