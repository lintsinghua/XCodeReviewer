name: å®šæ—¶å‘å¸ƒ

# å®šæ—¶è§¦å‘ï¼ˆæ¯æœˆ1å·è‡ªåŠ¨å‘å¸ƒï¼‰
on:
  schedule:
    # æ¯æœˆ1å·çš„ UTC 00:00 (åŒ—äº¬æ—¶é—´ 08:00)
    - cron: '0 0 1 * *'
  
  # ä¹Ÿæ”¯æŒæ‰‹åŠ¨è§¦å‘
  workflow_dispatch:

jobs:
  check-and-release:
    name: æ£€æŸ¥å¹¶å‘å¸ƒ
    runs-on: ubuntu-latest
    
    permissions:
      contents: write
    
    steps:
      # 1. æ£€å‡ºä»£ç 
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      # 2. æ£€æŸ¥æ˜¯å¦æœ‰æ–°çš„æäº¤
      - name: æ£€æŸ¥æ˜¯å¦æœ‰æ–°æäº¤
        id: check
        run: |
          # è·å–æœ€åä¸€ä¸ª tag
          LAST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "")
          
          if [ -z "$LAST_TAG" ]; then
            echo "has_changes=true" >> $GITHUB_OUTPUT
            echo "version=v2.0.0" >> $GITHUB_OUTPUT
          else
            # æ£€æŸ¥è‡ªä¸Šæ¬¡ tag ä»¥æ¥æ˜¯å¦æœ‰æ–°çš„æäº¤
            COMMITS_SINCE_TAG=$(git rev-list $LAST_TAG..HEAD --count)
            
            if [ "$COMMITS_SINCE_TAG" -gt "0" ]; then
              echo "has_changes=true" >> $GITHUB_OUTPUT
              
              # è‡ªåŠ¨è®¡ç®—ä¸‹ä¸€ä¸ªç‰ˆæœ¬å·ï¼ˆå°ç‰ˆæœ¬å· +1ï¼‰
              VERSION_NO_V="${LAST_TAG#v}"
              IFS='.' read -r -a VERSION_PARTS <<< "$VERSION_NO_V"
              MAJOR="${VERSION_PARTS[0]}"
              MINOR="${VERSION_PARTS[1]}"
              PATCH="${VERSION_PARTS[2]}"
              
              # å¢åŠ  minor ç‰ˆæœ¬
              NEXT_MINOR=$((MINOR + 1))
              NEXT_VERSION="v${MAJOR}.${NEXT_MINOR}.0"
              
              echo "version=$NEXT_VERSION" >> $GITHUB_OUTPUT
            else
              echo "has_changes=false" >> $GITHUB_OUTPUT
            fi
          fi
      
      # 3. åˆ›å»ºæ–°çš„ tag
      - name: åˆ›å»ºç‰ˆæœ¬æ ‡ç­¾
        if: steps.check.outputs.has_changes == 'true'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git tag -a ${{ steps.check.outputs.version }} -m "è‡ªåŠ¨å‘å¸ƒ: ${{ steps.check.outputs.version }}"
          git push origin ${{ steps.check.outputs.version }}
      
      # 4. è§¦å‘å‘å¸ƒå·¥ä½œæµ
      - name: è§¦å‘å‘å¸ƒ
        if: steps.check.outputs.has_changes == 'true'
        run: |
          echo "âœ… æ–°ç‰ˆæœ¬ ${{ steps.check.outputs.version }} å·²åˆ›å»º"
          echo "ğŸš€ Release å·¥ä½œæµå°†è‡ªåŠ¨å¼€å§‹æ„å»ºå’Œå‘å¸ƒ"
          echo "ğŸ“¦ å°†å‘å¸ƒä»¥ä¸‹ç»„ä»¶ï¼š"
          echo "  - å‰ç«¯ Docker é•œåƒ"
          echo "  - åç«¯ Docker é•œåƒ"
          echo "  - æ„å»ºäº§ç‰©å’Œæºç åŒ…"
