name: Release

# è§¦å‘æ¡ä»¶
on:
  # æ‰‹åŠ¨è§¦å‘
  workflow_dispatch:
    inputs:
      version:
        description: 'ç‰ˆæœ¬å· (ä¾‹å¦‚: v2.0.0)'
        required: true
        type: string
      prerelease:
        description: 'æ˜¯å¦ä¸ºé¢„å‘å¸ƒç‰ˆæœ¬'
        required: false
        type: boolean
        default: false
  
  # å½“æ¨é€ tag æ—¶è‡ªåŠ¨è§¦å‘ï¼ˆæ ¼å¼ï¼šv*.*.* ï¼‰
  push:
    tags:
      - 'v*.*.*'

jobs:
  build-and-release:
    name: æ„å»ºå¹¶å‘å¸ƒ
    runs-on: ubuntu-latest
    
    permissions:
      contents: write
      packages: write
    
    steps:
      # 1. æ£€å‡ºä»£ç 
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      # 2. è®¾ç½® Node.js ç¯å¢ƒï¼ˆç”¨äºå‰ç«¯æ„å»ºï¼‰
      - name: è®¾ç½® Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      # 3. å®‰è£… pnpm
      - name: å®‰è£… pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9
      
      # 4. è·å– pnpm store ç›®å½•
      - name: è·å– pnpm store ç›®å½•
        shell: bash
        run: |
          echo "STORE_PATH=$(pnpm store path --silent)" >> $GITHUB_ENV
      
      # 5. è®¾ç½® pnpm ç¼“å­˜
      - name: è®¾ç½® pnpm ç¼“å­˜
        uses: actions/cache@v4
        with:
          path: ${{ env.STORE_PATH }}
          key: ${{ runner.os }}-pnpm-store-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-pnpm-store-
      
      # 6. å®‰è£…å‰ç«¯ä¾èµ–
      - name: å®‰è£…å‰ç«¯ä¾èµ–
        working-directory: ./frontend
        run: pnpm install --frozen-lockfile
      
      # 7. æ„å»ºå‰ç«¯é¡¹ç›®
      - name: æ„å»ºå‰ç«¯é¡¹ç›®
        working-directory: ./frontend
        run: pnpm build
        env:
          VITE_USE_LOCAL_DB: 'true'
      
      # 8. è®¾ç½® Python ç¯å¢ƒï¼ˆç”¨äºåç«¯ï¼‰
      - name: è®¾ç½® Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.13'
      
      # 9. ç¡®å®šç‰ˆæœ¬å·
      - name: ç¡®å®šç‰ˆæœ¬å·
        id: version
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            echo "VERSION=${{ github.event.inputs.version }}" >> $GITHUB_OUTPUT
            echo "IS_PRERELEASE=${{ github.event.inputs.prerelease }}" >> $GITHUB_OUTPUT
          else
            echo "VERSION=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT
            echo "IS_PRERELEASE=false" >> $GITHUB_OUTPUT
          fi
          VERSION_NO_V="${VERSION#v}"
          echo "VERSION_NO_V=$VERSION_NO_V" >> $GITHUB_OUTPUT
      
      # 10. æ‰“åŒ…æ„å»ºäº§ç‰©
      - name: æ‰“åŒ…æ„å»ºäº§ç‰©
        run: |
          # åˆ›å»ºå‘å¸ƒç›®å½•
          mkdir -p release
          
          # æ‰“åŒ…å‰ç«¯æ„å»ºäº§ç‰©
          tar -czf release/xcodereviewer-frontend-${{ steps.version.outputs.VERSION }}.tar.gz -C frontend/dist .
          
          # æ‰“åŒ…åç«¯æºç 
          tar -czf release/xcodereviewer-backend-${{ steps.version.outputs.VERSION }}.tar.gz \
            --exclude=backend/.venv \
            --exclude=backend/.env \
            --exclude=backend/__pycache__ \
            --exclude=backend/uploads \
            backend/
          
          # æ‰“åŒ… Docker é…ç½®æ–‡ä»¶
          tar -czf release/xcodereviewer-docker-${{ steps.version.outputs.VERSION }}.tar.gz \
            docker-compose.yml \
            backend/Dockerfile \
            backend/.dockerignore \
            frontend/Dockerfile \
            frontend/.dockerignore \
            frontend/docker-entrypoint.sh \
            backend/env.example \
            frontend/.env.example
          
          # æ‰“åŒ…å®Œæ•´æºç ï¼ˆåŒ…æ‹¬é…ç½®æ–‡ä»¶ï¼‰
          tar -czf release/xcodereviewer-source-${{ steps.version.outputs.VERSION }}.tar.gz \
            --exclude=frontend/node_modules \
            --exclude=frontend/dist \
            --exclude=backend/.venv \
            --exclude=backend/.env \
            --exclude=backend/uploads \
            --exclude=.git \
            --exclude=release \
            .
          
          # åˆ›å»º checksums
          cd release
          sha256sum * > checksums.txt
          cd ..
      
      # 11. ç”Ÿæˆæ›´æ–°æ—¥å¿—
      - name: ç”Ÿæˆæ›´æ–°æ—¥å¿—
        id: changelog
        run: |
          # è·å–ä¸Šä¸€ä¸ª tag
          PREVIOUS_TAG=$(git describe --tags --abbrev=0 HEAD^ 2>/dev/null || echo "")
          
          if [ -z "$PREVIOUS_TAG" ]; then
            echo "è¿™æ˜¯ç¬¬ä¸€ä¸ªå‘å¸ƒç‰ˆæœ¬" > CHANGELOG.md
            git log --pretty=format:"- %s (%h)" >> CHANGELOG.md
          else
            echo "è‡ª $PREVIOUS_TAG ä»¥æ¥çš„å˜æ›´ï¼š" > CHANGELOG.md
            echo "" >> CHANGELOG.md
            git log $PREVIOUS_TAG..HEAD --pretty=format:"- %s (%h)" >> CHANGELOG.md
          fi
          
          echo "" >> CHANGELOG.md
          echo "" >> CHANGELOG.md
          echo "## ğŸ“¦ ä¸‹è½½è¯´æ˜" >> CHANGELOG.md
          echo "" >> CHANGELOG.md
          echo "### æ„å»ºäº§ç‰©" >> CHANGELOG.md
          echo "- \`xcodereviewer-frontend-*.tar.gz\`: å‰ç«¯æ„å»ºäº§ç‰©ï¼ˆç”¨äºç”Ÿäº§éƒ¨ç½²ï¼‰" >> CHANGELOG.md
          echo "- \`xcodereviewer-backend-*.tar.gz\`: åç«¯æºç åŒ…" >> CHANGELOG.md
          echo "- \`xcodereviewer-docker-*.tar.gz\`: Docker é…ç½®æ–‡ä»¶" >> CHANGELOG.md
          echo "- \`xcodereviewer-source-*.tar.gz\`: å®Œæ•´æºç åŒ…" >> CHANGELOG.md
          echo "- \`checksums.txt\`: æ–‡ä»¶æ ¡éªŒå’Œ" >> CHANGELOG.md
          echo "" >> CHANGELOG.md
          echo "### Docker é•œåƒ" >> CHANGELOG.md
          echo "- Frontend: \`ghcr.io/${{ github.repository_owner }}/xcodereviewer-frontend:${{ steps.version.outputs.VERSION }}\`" >> CHANGELOG.md
          echo "- Backend: \`ghcr.io/${{ github.repository_owner }}/xcodereviewer-backend:${{ steps.version.outputs.VERSION }}\`" >> CHANGELOG.md
          echo "" >> CHANGELOG.md
          echo "### å¿«é€Ÿéƒ¨ç½²" >> CHANGELOG.md
          echo "\`\`\`bash" >> CHANGELOG.md
          echo "# ä½¿ç”¨ Docker Compose éƒ¨ç½²" >> CHANGELOG.md
          echo "docker-compose up -d" >> CHANGELOG.md
          echo "\`\`\`" >> CHANGELOG.md
      
      # 12. åˆ›å»º GitHub Release
      - name: åˆ›å»º Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.version.outputs.VERSION }}
          name: Release ${{ steps.version.outputs.VERSION }}
          body_path: CHANGELOG.md
          draft: false
          prerelease: ${{ steps.version.outputs.IS_PRERELEASE }}
          files: |
            release/*
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      # 13. ç™»å½• GitHub Container Registry
      - name: ç™»å½•åˆ° GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
      
      # 14. è®¾ç½® QEMUï¼ˆç”¨äºå¤šæ¶æ„æ„å»ºï¼‰
      - name: è®¾ç½® QEMU
        uses: docker/setup-qemu-action@v3
      
      # 15. è®¾ç½® Docker Buildx
      - name: è®¾ç½® Docker Buildx
        uses: docker/setup-buildx-action@v3
      
      # 16. æ„å»ºå¹¶æ¨é€å‰ç«¯ Docker é•œåƒ
      - name: æ„å»ºå¹¶æ¨é€å‰ç«¯ Docker é•œåƒ
        uses: docker/build-push-action@v5
        with:
          context: ./frontend
          file: ./frontend/Dockerfile
          push: true
          platforms: linux/amd64,linux/arm64
          tags: |
            ghcr.io/${{ github.repository_owner }}/xcodereviewer-frontend:${{ steps.version.outputs.VERSION }}
            ghcr.io/${{ github.repository_owner }}/xcodereviewer-frontend:latest
          cache-from: type=gha,scope=frontend
          cache-to: type=gha,mode=max,scope=frontend
      
      # 17. æ„å»ºå¹¶æ¨é€åç«¯ Docker é•œåƒ
      - name: æ„å»ºå¹¶æ¨é€åç«¯ Docker é•œåƒ
        uses: docker/build-push-action@v5
        with:
          context: ./backend
          file: ./backend/Dockerfile
          push: true
          platforms: linux/amd64,linux/arm64
          tags: |
            ghcr.io/${{ github.repository_owner }}/xcodereviewer-backend:${{ steps.version.outputs.VERSION }}
            ghcr.io/${{ github.repository_owner }}/xcodereviewer-backend:latest
          cache-from: type=gha,scope=backend
          cache-to: type=gha,mode=max,scope=backend
      
      # 18. æ›´æ–° README ä¸­çš„ç‰ˆæœ¬å·
      - name: æ›´æ–° README ç‰ˆæœ¬å·
        if: github.event_name == 'push'
        run: |
          VERSION="${{ steps.version.outputs.VERSION_NO_V }}"
          sed -i "s/version-[0-9]*\.[0-9]*\.[0-9]*/version-$VERSION/g" README.md
          
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add README.md
          git commit -m "docs: update README version to $VERSION" || true
          git push origin HEAD:main || true
